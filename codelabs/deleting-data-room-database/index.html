
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>TP 04.2B: Deleting data from a Room database</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T70T90JTWB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-T70T90JTWB');
  </script>
</head>
<body>
  <google-codelab-analytics gaid="UA-3295395-7"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="deleting-data-room-database"
                  title="TP 04.2B: Deleting data from a Room database"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="Bienvenue" duration="0">
        <p>Ces travaux pratiques se base sur le cours de base pour les développeurs Android fourni par Google afin de  les préparer pour le test de certification <a href="https://developers.google.com/training/certification/associate-android-developer/" target="_blank">Associate Android Developer</a>. Vous obtiendrez le plus de valeur de ce TP si vous travaillez successivement dans les codelabs.</p>
<h2 is-upgraded>Introduction</h2>
<p>This codelab (practical) follows on from 4.2A: Room, LiveData, and ViewModel. This codelab gives you more practice at using the API provided by the Room library to implement database functionality. You will add the ability to delete specific items from the database. This codelab also includes a coding challenge, in which you update the app so the user can edit existing data.</p>
<h2 is-upgraded>What you should already know</h2>
<p>You should be able to create and run apps in <a href="https://developer.android.com/studio/index.html" target="_blank">Android Studio 3.0 or higher</a>. In particular, be familiar with the following:</p>
<ul>
<li>Using <code>RecyclerView</code> and adapters.</li>
<li>Using entity classes, data access objects (DAOs), and the <code>RoomDatabase</code> to store and retrieve data in Android&#39;s built-in SQLite database. You learned these topics in 4.1A: Room, LiveData, and ViewModel.</li>
</ul>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>How to populate the database with data only if the database is empty (so users don&#39;t lose changes they made to the data).</li>
<li>How to delete data from a Room database.</li>
<li>How to update existing data (if you build the challenge app).</li>
</ul>
<h2 is-upgraded>What you&#39;ll do</h2>
<ul>
<li>Update the RoomWordsSample app to keep data when the app closes.</li>
<li>Allow users to delete all words by selecting an <strong>Options</strong> menu item.</li>
<li>Allow users to delete a specific word by swiping an item in the list.</li>
<li>Optionally, in a coding challenge, extend the app to allow the user to update existing words.</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Aperçu de l&#39;application" duration="0">
        <p>You will extend the RoomWordsSample app that you created in the previous codelab. So far, that app displays a list of words, and users can add words. When the app closes and re-opens, the app re-initializes the database. Words that the user has added are lost.</p>
<p>In this practical, you extend the app so that it only initializes the data in the database if there is no existing data.</p>
<p>Then you add a menu item that allows the user to delete all the data.</p>
<p class="image-container"><img style="width: 624.00px" src="img/ba683f98ec094a10.png"></p>
<p>You also enable the user to swipe a word to delete it from the database.</p>
<p class="image-container"><img style="width: 288.00px" src="img/1fc13b1dec09c03.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Tâche 1: Initialize data only if the database is empty" duration="0">
        <p>The RoomWordsSample app that you created in the previous practical deletes and re-creates the data whenever the user opens the app. This behavior isn&#39;t ideal, because users will want their added words to remain in the database when the app is closed. (Solution code for the previous practical is in <a href="https://github.com/khammami/android-fundamentals-exycodelabs/tree/master/RoomWordsSample" target="_blank">GitHub</a>.)</p>
<p>In this task you update the app so that when it opens, the initial data set is only added if the database has no data.</p>
<p>To detect whether the database contains data already, you can run a query to get one data item. If the query returns nothing, then the database is empty.</p>
<aside class="special"><p><strong>Note</strong>: In a production app, you might want to allow users to delete all data without re-initializing the data when the app restarts. But for testing purposes, it&#39;s useful to be able to delete all data, then re-initialize the data when the app starts.</p>
</aside>
<h2 is-upgraded>1.1 Add a method to the DAO to get a single word</h2>
<p>Currently, the <code>WordDao</code> interface has a method for getting all the words, but not for getting any single word. The method to get a single word does not need to return <code>LiveData</code>, because your app will call the method explicitly when needed.</p>
<ol type="1" start="1">
<li>In the <code>WordDao</code> interface, add a method to get any word:</li>
</ol>
<pre><code>@Query(&#34;SELECT * from word_table LIMIT 1&#34;)
    Word[] getAnyWord();</code></pre>
<p><code>Room</code> issues the database query when the <code>getAnyWord()</code> method is called and returns an array containing one word. You don&#39;t need to write any additional code to implement it.</p>
<h2 is-upgraded>1.2 Update the initialization method to check whether data exists</h2>
<p>Use the <code>getAnyWord()</code> method in the method that initializes the database. If there is any data, leave the data as it is. If there is no data, add the initial data set.</p>
<ol type="1" start="1">
<li><code>PopulateDBAsync</code> is an inner class in <code>WordRoomDatbase</code>. In <code>PopulateDBAsync</code>, update the <code>doInBackground()</code> method to check whether the database has any words before initializing the data:</li>
</ol>
<pre><code>@Override
protected Void doInBackground(final Void... params) {

       // If we have no words, then create the initial list of words
       if (mDao.getAnyWord().length &lt; 1) {
           for (int i = 0; i &lt;= words.length - 1; i++) {
               Word word = new Word(words[i]);
               mDao.insert(word);
           }
       }
   return null;
}</code></pre>
<ol type="1" start="2">
<li>Run your app and add several new words. Close the app and restart it. You should see the new words that you added, as the words should now persist when the app is closed and opened again.</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Tâche 2: Delete all words" duration="0">
        <p>In the previous practical, you used the <code>deleteAll()</code> method to clear out all the data when the database opened. The <code>deleteAll()</code> method was only invoked from the <code>PopulateDbAsync</code> class when the app started. You will now make the <code>deleteAll()</code> method available through the <code>ViewModel</code> so that your app can call the method whenever it&#39;s needed.</p>
<p>Here are the general steps for implementing a method to use the <code>Room</code> library to interact with the database:</p>
<ul>
<li>Add the method to the DAO, and annotate it with the relevant database operation. For the <code>deleteAll()</code> method, you already did this step in the previous practical.</li>
<li>Add the method to the <code>WordRepository</code> class. Write the code to run the method in the background.</li>
<li>To call the method in the <code>WordRepository</code> class, add the method to the <code>WordViewModel</code>. The rest of the app can then access the method through the <code>WordViewModel</code>.</li>
</ul>
<h2 is-upgraded>2.1 Add deleteAll() to the WordDao interface and annotate it</h2>
<ol type="1" start="1">
<li>In <code>WordDao</code>, check that the <code>deleteAll()</code> method is defined and annotated with the SQL that runs when the method executes:</li>
</ol>
<pre><code>@Query(&#34;DELETE FROM word_table&#34;)
void deleteAll();</code></pre>
<h2 is-upgraded>2.2 Add deleteAll() to the WordRepository class</h2>
<p>Add the <code>deleteAll()</code> method to the <code>WordRepository</code> and implement an <code>AsyncTask</code> to delete all words in the background.</p>
<ol type="1" start="1">
<li>In <code>WordRepository</code>, define <code>deleteAllWordsAsyncTask</code> as an inner class. Implement <code>doInBackground()</code> to delete all the words by calling <code>deleteAll()</code> on the DAO:</li>
</ol>
<pre><code>private static class deleteAllWordsAsyncTask extends AsyncTask&lt;Void, Void, Void&gt; {
   private WordDao mAsyncTaskDao;

   deleteAllWordsAsyncTask(WordDao dao) {
       mAsyncTaskDao = dao;
   }

   @Override
   protected Void doInBackground(Void... voids) {
       mAsyncTaskDao.deleteAll();
       return null;
   }
}</code></pre>
<ol type="1" start="2">
<li>In the <code>WordRepository</code> class, add the <code>deleteAll()</code> method to invoke the <code>AsyncTask</code> that you defined.</li>
</ol>
<pre><code>public void deleteAll()  {
   new deleteAllWordsAsyncTask(mWordDao).execute();
}</code></pre>
<h2 is-upgraded>2.3 Add deleteAll() to the WordViewModel class</h2>
<p>Make the <code>deleteAll()</code> method available to the <code>MainActivity</code> by adding it to the <code>WordViewModel</code>.</p>
<ol type="1" start="1">
<li>In the <code>WordViewModel</code> class, add the <code>deleteAll()</code> method:</li>
</ol>
<pre><code>public void deleteAll() {mRepository.deleteAll();}</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Tâche 3: Add an Options menu item to delete all data" duration="0">
        <p>Next, you add a menu item to enable users to invoke <code>deleteAll()</code>.</p>
<aside class="special"><p><strong>Note</strong>: The production version of your app must provide safeguards so that users do not accidentally wipe out their entire database. However, while you develop your app, it&#39;s helpful to be able to clear out test data quickly. This is especially true now that your app does not clear out the data when the app opens.</p>
</aside>
<h2 is-upgraded>3.1 Add the Clear all data menu option</h2>
<ol type="1" start="1">
<li>In <code>menu_main.xml</code>, change the menu option <code>title</code> and <code>id</code>, as follows:</li>
</ol>
<pre><code>&lt;item
   android:id=&#34;@+id/clear_data&#34;
   android:orderInCategory=&#34;100&#34;
   android:title=&#34;@string/clear_all_data&#34;
   app:showAsAction=&#34;never&#34; /&gt;</code></pre>
<ol type="1" start="2">
<li>In <code>MainActivity</code>, implement the <code>onOptionsItemSelected()</code> method to invoke the <code>deleteAll()</code> method on the <code>WordViewModel</code> object.</li>
</ol>
<pre><code>@Override
public boolean onOptionsItemSelected(MenuItem item) {
   int id = item.getItemId();

   if (id == R.id.clear_data) {
       // Add a toast just for confirmation
       Toast.makeText(this, &#34;Clearing the data...&#34;,
               Toast.LENGTH_SHORT).show();

       // Delete the existing data
       mWordViewModel.deleteAll();
       return true;
   }

   return super.onOptionsItemSelected(item);
}</code></pre>
<ol type="1" start="3">
<li>Run your app. In the <strong>Options</strong> menu, select <strong>Clear all data</strong>. All words should disappear.</li>
<li>Restart the app. (Restart it from your device or the emulator; don&#39;t run it again from Android Studio) You should see the initial set of words.</li>
</ol>
<aside class="special"><p><strong>Note</strong>: After you clear the data, re-deploying the app from Android Studio shows the initial data set again. Opening the app shows the empty data set.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Tâche 4: Delete a single word" duration="0">
        <p>Your app lets users add words and delete all words. In Tasks 4 and 5, you extend the app so that users can delete a word by swiping the item in the <code>RecyclerView</code>.</p>
<p>Again, here are the general steps to implement a method to use the <code>Room</code> library to interact with the database:</p>
<ul>
<li>Add the method to the DAO, and annotate it with the relevant database operation.</li>
<li>Add the method to the <code>WordRepository</code> class. Write the code to run the method in the background.</li>
<li>To call the method in the <code>WordRepository</code> class, add the method to the <code>WordViewModel</code>. The rest of the app can then access the method through the <code>WordViewModel</code>.</li>
</ul>
<h2 is-upgraded>4.1 Add deleteWord() to the DAO and annotate it</h2>
<ol type="1" start="1">
<li>In <code>WordDao</code>, add the <code>deleteWord()</code> method:</li>
</ol>
<pre><code>@Delete
void deleteWord(Word word);</code></pre>
<p>Because this operation deletes a single row, the <code>@Delete</code> annotation is all that is needed to delete the word from the database.</p>
<h2 is-upgraded>4.2 Add deleteWord() to the WordRepository class</h2>
<ol type="1" start="1">
<li>In <code>WordRepository</code>, define another <code>AsyncTask</code> called <code>deleteWordAsyncTask</code> as an inner class. Implement <code>doInBackground()</code> to delete a word by calling <code>deleteWord()</code> on the DAO:</li>
</ol>
<pre><code>private static class deleteWordAsyncTask extends AsyncTask&lt;Word, Void, Void&gt; {
   private WordDao mAsyncTaskDao;

   deleteWordAsyncTask(WordDao dao) {
       mAsyncTaskDao = dao;
   }

   @Override
   protected Void doInBackground(final Word... params) {
       mAsyncTaskDao.deleteWord(params[0]);
       return null;
   }
}</code></pre>
<ol type="1" start="2">
<li>In <code>WordRepository</code>, add the <code>deleteWord()</code> method to invoke the <code>AsyncTask</code> you defined.</li>
</ol>
<pre><code>public void deleteWord(Word word)  {
   new deleteWordAsyncTask(mWordDao).execute(word);
}</code></pre>
<h2 is-upgraded>4.3 Add deleteWord() to the WordViewModel class</h2>
<p>To make the <code>deleteWord()</code> method available to other classes in the app, in particular, <code>MainActivity</code>, add it to <code>WordViewModel</code>.</p>
<ol type="1" start="1">
<li>In <code>WordViewModel</code>, add the <code>deleteWord()</code> method:</li>
</ol>
<pre><code>public void deleteWord(Word word) {mRepository.deleteWord(word);}</code></pre>
<p>You have now implemented the logic to delete a word. As yet, there is no way to invoke the delete-word operation from the app&#39;s UI. You fix that next.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Tâche 5: Enable users to swipe words away" duration="0">
        <p>In this task, you add functionality to allow users to swipe an item in the <code>RecyclerView</code> to delete it.</p>
<p>Use the <a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.html" target="_blank"><code>ItemTouchHelper</code></a> class provided by the Android Support Library (version 7 and higher or androidx) to implement swipe functionality in your <code>RecyclerView</code>. The <code>ItemTouchHelper</code> class has the following methods:</p>
<ul>
<li><code>onMove()</code> is called when the user moves the item. You will not implement any move functionality in this app.</li>
<li><code>onSwipe()</code> is called when the user swipes the item. You implement this method to delete the word that was swiped.</li>
</ul>
<p class="image-container"><img style="width: 288.00px" src="img/1fc13b1dec09c03.png"></p>
<h2 is-upgraded>5.1 Enable the adapter to detect the swiped word</h2>
<ol type="1" start="1">
<li>In <code>WordListAdapter</code>, add a method to get the word at a given position.</li>
</ol>
<pre><code>public Word getWordAtPosition (int position) {
   return mWords.get(position);
}</code></pre>
<ol type="1" start="2">
<li>In <code>MainActivity</code>, in <code>onCreate()</code>, create the <code>ItemTouchHelper</code>. Attach the <code>ItemTouchHelper</code> to the <code>RecyclerView</code>.</li>
</ol>
<pre><code>// Add the functionality to swipe items in the 
// recycler view to delete that item
ItemTouchHelper helper = new ItemTouchHelper(
    new ItemTouchHelper.SimpleCallback(0,
        ItemTouchHelper.LEFT | ItemTouchHelper.RIGHT) {
           @Override
           public boolean onMove(RecyclerView recyclerView,
                                 RecyclerView.ViewHolder viewHolder,
                                 RecyclerView.ViewHolder target) {
               return false;
           }

           @Override
           public void onSwiped(RecyclerView.ViewHolder viewHolder, 
                                int direction) {
               int position = viewHolder.getAdapterPosition();
               Word myWord = adapter.getWordAtPosition(position);
               Toast.makeText(MainActivity.this, &#34;Deleting &#34; + 
                       myWord.getWord(), Toast.LENGTH_LONG).show();

               // Delete the word
               mWordViewModel.deleteWord(myWord);
            }
       });

helper.attachToRecyclerView(recyclerView);</code></pre>
<p><strong>Things to notice in the code:</strong></p>
<p><code>onSwiped()</code> gets the position of the <code>ViewHolder</code> that was swiped:</p>
<pre><code>int position = viewHolder.getAdapterPosition();</code></pre>
<p>Given the position, you can get the word displayed by the <code>ViewHolder</code> by calling the <code>getWordAtPosition()</code> method that you defined in the adapter:</p>
<pre><code>Word myWord = adapter.getWordAtPosition(position);</code></pre>
<p>Delete the word by calling <code>deleteWord()</code> on the <code>WordViewModel</code>:</p>
<pre><code>mWordViewModel.deleteWord(myWord);</code></pre>
<p><strong>Now run your app and delete some words</strong></p>
<ol type="1" start="1">
<li>Run your app. You should be able to delete words by swiping them left or right.</li>
</ol>
<h2 is-upgraded>Solution code</h2>
<p>Android Studio project: <a href="https://github.com/khammami/android-fundamentals-exycodelabs/tree/master/RoomWordsWithDelete" target="_blank">RoomWordsWithDelete</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="Défi de codage" duration="0">
        <aside class="special"><p><strong>Note</strong>: All coding challenges are optional and are not prerequisites for later lessons.</p>
</aside>
<p>Challenge: Update your app to allow users to edit a word by tapping the word and then saving their changes.</p>
<h2 is-upgraded>Hints</h2>
<p><strong>Make changes in NewWordActivity</strong></p>
<p>You can add functionality to <code>NewWordActivity</code>, so that it can be used either to add a new word or edit an existing word.</p>
<p><strong>Use an auto-generated key in Word</strong></p>
<p>The <code>Word</code> entity class uses the <code>word</code> field as the database key. However, when you update a row in the database, the item being updated cannot be the primary key, because the primary key is unique to each row and never changes. So you need to add an auto-generated <code>id</code> to use as the primary key</p>
<pre><code>@PrimaryKey(autoGenerate = true)
private int id;

@NonNull
@ColumnInfo(name = &#34;word&#34;)
private String mWord;</code></pre>
<p><strong>Add a constructor for </strong><strong><code>Word</code></strong><strong> that takes an </strong><strong><code>id</code></strong></p>
<p>Add a constructor to the <code>Word</code> entity class that takes <code>id</code> and <code>word</code> as parameters. Make sure this additional constructor is annotated using <code>@Ignore</code>, because <code>Room</code> expects only one constructor by default in an entity class.</p>
<pre><code>@Ignore
public Word(int id, @NonNull String word) {
   this.id = id;
   this.mWord = word;
}</code></pre>
<p>To update an existing <code>Word</code>, create the <code>Word</code> using this constructor. <code>Room</code> will use the primary key (in this case the <code>id</code>) to find the existing entry in the database so it can be updated.</p>
<p>In <code>WordDao</code>, add the <code>update()</code> method like this:</p>
<pre><code>@Update
void update(Word... word);</code></pre>
<p>In <code>WordRoomDatabase</code>, increase the database version number, since database table schema is changed.</p>
<pre><code>@Database(entities = {Word.class}, version = 2, exportSchema = false)</code></pre>
<h2 is-upgraded>Challenge solution code</h2>
<p>Android Studio project: <a href="https://github.com/khammami/android-fundamentals-exycodelabs/tree/master/RoomWordsWithUpdate" target="_blank">RoomWordsWithUpdate</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="Résumé" duration="0">
        <h2 is-upgraded>Writing database code</h2>
<ul>
<li>Room takes care of opening and closing the database connections each time a database operations executes.</li>
<li>Annotate methods in the data access object (DAO) as <code>@insert</code>, <code>@delete</code>, <code>@update</code>, <code>@query</code>.</li>
<li>For simple insertions, updates and deletions, it is enough to add the relevant annotation to the method in the DAO.</li>
</ul>
<p>For example:</p>
<pre><code>@Delete
void deleteWord(Word word);

@Update
void update(Word... word);</code></pre>
<ul>
<li>For queries or more complex database interactions, such as deleting all words, use the <code>@query</code> annotation and provide the SQL for the operation.</li>
</ul>
<p>For example:</p>
<pre><code>@Query(&#34;SELECT * from word_table ORDER BY word ASC&#34;)
LiveData&lt;List&lt;Word&gt;&gt; getAllWords();

@Query(&#34;DELETE FROM word_table&#34;)
void deleteAll();</code></pre>
<h2 is-upgraded>ItemTouchHelper</h2>
<ul>
<li>To enable users to swipe or move items in a <code>RecyclerView</code>, you can use the <code>ItemTouchHelper</code> class.</li>
<li>Implement <code>onMove()</code> and <code>onSwipe()</code>.</li>
<li>To identify which item the user moved or swiped, you can add a method to the adapter for the <code>RecylerView</code>. The method takes a position and returns the relevant item. Call the method inside <code>onMove()</code> or <code>onSwipe()</code>.</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Apprendre encore plus" duration="0">
        <p>Entities, data access objects (DAOs), and <code>ViewModel</code>:</p>
<ul>
<li><a href="https://developer.android.com/training/data-storage/room/defining-data.html" target="_blank">Defining data using Room entities</a></li>
<li><a href="https://developer.android.com/training/data-storage/room/accessing-data.html" target="_blank">Accessing data using Room DAOs</a></li>
<li><a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html" target="_blank"><code>ViewModel</code> guide</a></li>
<li><a href="https://developer.android.com/reference/android/arch/persistence/room/Dao.html" target="_blank"><code>Dao</code> reference</a></li>
<li><a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank"><code>ViewModel</code> reference</a></li>
<li>To see all the possible annotations for an entity, go to <a href="https://developer.android.com/reference/android/arch/persistence/room/package-summary.html" target="_blank"><code>android.arch.persistence.room</code></a> in the Android reference and expand the Annotations menu item in the left nav.<br><img style="width: 242.00px" src="img/7b93930648bd96c0.png"></li>
</ul>
<p><code>ItemTouchHelper</code>:</p>
<ul>
<li><a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.html" target="_blank"><code>ItemTouchHelper</code></a> reference</li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
